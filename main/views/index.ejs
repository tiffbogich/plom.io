<% include layout %>

<script src="/javascripts/plomGraphModel.js"></script>
<script src="/javascripts/index.js"></script>
    
<% include header %>


<section>

  <form>
    <div class="input-append">
      <input type="text" name="q" id="plom-search" class="span4"/>
      <button type="submit" class="btn">Search</button>
    </div>
  </form>

  <div class="app-folders-container"> 


    <!-- the contexts -->
    <% ctree.forEach(function(c, i){ %>

    <% if ( (i%3) === 0 ){ %>
    <div class="jaf-row jaf-container">
    <% } %>

    <div class="folder context-box" id="<%= c._id %>">

      <a href="#"><%= c.disease.join('; ') + ' / ' + c.name %></a>

      <p>
        <%= c.model.length %> model<%= (c.model.length > 1) ? 's': ''%>; <%= (c.contributor && c.contributor.length) || 0 %> contributor<%= (c.contributor && (c.contributor.length > 1)) ? 's': '' %>
      </p>

      <!-- placeholder for timeseries plot -->
      <div id="graphdiv<%= i %>" class="context-graph"></div>

      <select id="ts-picker-<%= i %>"  class="ts-picker">
        <option value="-1">All time series</option>
        <% c.time_series.forEach(function(ts, indts){ %>
        <option value="<%= indts %>"><%= ts.id.split('__').join('; ') %></option>
        <% }); %>
      </select>

      <!--
      <p>
        <%=: c.description | truncate:30 %>
      </p>
      -->

    </div>

    <% if (((i+1) %3) === 0  || i === 4){ %>
    </div>
    <% } %>
    <% }); %>

    <!-- the models -->
    <% ctree.forEach(function(c, i){ %>
    <div class="folderContent <%= c._id %>">
      <div class="jaf-container">        

        <div class="horizontal-scroll">

          <% c.model.forEach(function(m, j){ %>
          <div class="model-box">
            
            <a href="#"><%= m.process.name + ' - ' + m.link.name %></a>

            <!-- placeholder for d3 viz of compartmental model -->
            <div id="pgraph<%= m.link._id %>" class="process-graph"></div>

            <!-- score (DIC or AICc or rating) -->
            <% if (m.theta) { %>
            <div class="score">
              <% if ('diagnostic' in m.theta) { %>
              DIC: <span><%= m.theta.diagnostic.summary.map(function(x){ return x.dic.toFixed(2); }).sort(function(a,b){return a-b;})[0] %></span>
              <% } else { %>
              AICc: <span><%= m.theta && m.theta.information_criterion.AICc.toFixed(2) %></span>
              <% }; %>
            </div>
            <% }; %>

            <form action="/fork" method="POST" class="explore">
              <input type="hidden" name="context" value="<%= c._id %>" />
              <input type="hidden" name="process" value="<%= m.process._id %>" />
              <input type="hidden" name="link" value="<%= m.link._id %>" />
              <input type="hidden" name="theta" value="<%= m.theta._id %>" />
              <input type="hidden" name="_csrf" value="<%= token %>"/>
              <input class="btn" type="submit" value="Fork" />
            </form>

            <form action="/library" method="POST" class="explore">
              <input type="hidden" name="context" value="<%= c._id %>" />
              <input type="hidden" name="process" value="<%= m.process._id %>" />
              <input type="hidden" name="link" value="<%= m.link._id %>" />
              <input type="hidden" name="_csrf" value="<%= token %>"/>
              <input class="btn" type="submit" value="Review" />
            </form>            
            
            <div class="parameter-box">
              <% if (m.theta && m.theta.parameter) { %>
              <ul>                     
                <% m.process.parameter.concat(m.process.state, m.link.parameter).forEach(function(par){  %>
                <% if (par.id in m.theta.parameter) { %>
                <li>
                  <a href="#" class="plom-tooltip" data-placement="left" rel="tooltip" data-original-title="<%= m.theta.parameter[par.id].comment %>"><%= par.id %></a> :
                    
                  <% if(Object.keys(m.theta.parameter[par.id]['group']).length >1 ) {%>
                  <ul>
                    <% for (var group in m.theta.parameter[par.id].group) { %>
                    <li><%= group.split('__').join('; ') %>: <%= m.theta.parameter[par.id]['group'][group]['guess']['value'] %> </li>
                    <% }; %>
                  </ul>
                  <% } else { %>
                  <%= m.theta.parameter[par.id]['group'][Object.keys(m.theta.parameter[par.id].group)[0]]['guess']['value'] %>
                  <% }; %>
                </li>
                <% }; %>
                <% }); %>
              </ul>
              <% }; %>
            </div>

            Involved in:
            <div class="related-box">
              <ul>
                <% m.process.related.forEach(function(x){ %>
                <li><a href="#"><%= x %></a></li>
                <% }); %>
              </ul>
            </div>

          </div>
          <% }); %>
        </div>
      </div>
      <% }); %>
    </div>

  </div>


</section>


<hr />
<% include footer %>
